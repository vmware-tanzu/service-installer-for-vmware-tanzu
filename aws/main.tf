# Copyright 2021 VMware, Inc
# SPDX-License-Identifier: BSD-2-Clause
# tkg init --config ./tkg-aws.yaml  -i aws -p prod --ceip-participation false --name iz-aws --cni antrea -v 6

terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 3.0"
    }
  }
}

provider "aws" {
  region = var.aws_region
  default_tags {
    tags = {
      CreatedBy = "Arcas"
      RunId     = var.run_id
    }
  }
  ignore_tags {
    keys = ["kubernetes.io"]
  }
}



variable "aws_region" {
  default = "us-west-2"
}

variable "run_id" {
  default = "none"
}


variable "jb_key_file" {
  default = "./tkgkp.pem"
}

variable "jb_key_pair" {
  default = "tkg-kp"
}

resource "aws_ec2_transit_gateway" "transitgw" {
  description = "transit gw"
}


module "control_plane" {
  source        = "./tkg_vpc"
  vpc_subnet    = "172.16.0.0/16"
  jumpbox       = true
  transit_gw    = aws_ec2_transit_gateway.transitgw.id
  transit_block = "172.16.0.0/12"
  name          = "control-plane"
  jb_key_pair   = var.jb_key_pair
  jb_keyfile    = var.jb_key_file
  cluster_name  = "tkg-mgmt-aws"
  azs           = ["${var.aws_region}a", "${var.aws_region}b", "${var.aws_region}c"]
}

module "workload_vpc" {
  source        = "./tkg_vpc"
  vpc_subnet    = "172.19.0.0/16" // avoiding .17 and .18 so that we don't conflict with docker
  jumpbox       = false
  transit_gw    = aws_ec2_transit_gateway.transitgw.id
  transit_block = "172.16.0.0/12"
  name          = "workload"
  cluster_name  = "tkg-workload"
  azs           = ["${var.aws_region}a", "${var.aws_region}b", "${var.aws_region}c"]
  jb_key_pair   = var.jb_key_pair
  jb_keyfile    = var.jb_key_file
  jumpbox_ip    = module.control_plane.jumpbox_ip

}

output "jumpbox_dns" {
  value = module.control_plane.jumpbox_dns
}
